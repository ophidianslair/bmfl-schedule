<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BMFL Float Plan - Today & Tomorrow</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f0f0f0; }
    .box { max-width:1200px; margin:auto; background:white; padding:30px; border-radius:12px; box-shadow:0 6px 25px rgba(0,0,0,0.15); }
    h1 { text-align:center; color:#1a73e8; margin-bottom:10px; }
    h2 { color:#202124; border-bottom:3px solid #1a73e8; padding-bottom:10px; }
    table { width:100%; border-collapse:collapse; margin:25px 0; font-size:15px; }
    th { background:#1a73e8; color:white; padding:14px; text-align:left; }
    td { padding:12px 14px; border-bottom:1px solid #ddd; background:#fafafa; }
    tr:hover td { background:#f1f7ff; }
    .updated { text-align:center; color:#666; margin-top:40px; font-size:0.95em; }
    .no-events { font-style:italic; color:#888; text-align:center; padding:20px; }
    .error { color:red; text-align:center; padding:20px; }
  </style>
</head>
<body>
  <div class="box">
    <h1>BMFL Float Plan Schedule</h1>
    <div id="today"></div>
    <div id="tomorrow"></div>
    <div class="updated">Last updated: <span id="time">-</span></div>
  </div>

  <script>
    const CSV_URL = 'https://cors-anywhere.herokuapp.com/https://docs.google.com/spreadsheets/d/e/2PACX-1vSsRekGv-RS1weoQOYj2f53938BZ2VVr0S9WT0VXgpW3XBKLuHWKcjwEPwyB_iJpTL60TIwKw4UQrb0/pub?gid=1802475877&single=true&output=csv';
    const DATE_COLUMN = 'Departure Date (mm/dd/yyyy)';

    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      if (lines.length < 2) {
        document.getElementById('today').innerHTML = '<div class="error">CSV has no data lines. Republish sheet.</div>';
        return [];
      }
      const headers = lines[0].split(',').map(h => h.replace(/^"|"$/g, '').trim());
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, '').trim());
        if (values.length < headers.length) continue;
        const row = {};
        headers.forEach((h, idx) => row[h] = values[idx] || '');
        rows.push(row); // Show all rows, even without date
      }
      return rows;
    }

    function getTodayTomorrow() {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      return {
        today: today.toISOString().split('T')[0],
        tomorrow: tomorrow.toISOString().split('T')[0],
        todayPretty: today.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }),
        tomorrowPretty: tomorrow.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })
      };
    }

    function makeTable(rows, title) {
      if (rows.length === 0) return `<div class="no-events">No reservations for ${title}</div>`;
      let html = `<h2>${title}</h2><table><thead><tr>
        <th>Name (B)</th><th>Departure Date (C)</th><th>Boat (D)</th><th>Truck (E)</th><th>Destination (F)</th><th>Expected Return (I)</th><th>Departure Time (J)</th>
      </tr></thead><tbody>`;
      rows.forEach(row => {
        html += `<tr>
          <td>${row['Name'] || ''}</td>
          <td>${row['Departure Date (mm/dd/yyyy)'] || ''}</td>
          <td>${row['Boat used'] || ''}</td>
          <td>${row['Truck used'] || ''}</td>
          <td>${row['Destination'] || ''}</td>
          <td>${row['Expected return time.'] || ''}</td>
          <td>${row['Departure Time'] || ''}</td>
        </tr>`;
      });
      return html + '</tbody></table>';
    }

    function render() {
      const dates = getTodayTomorrow();
      fetch(`${CSV_URL}&t=${Date.now()}`)
        .then(r => {
          if (!r.ok) throw new Error('Fetch failed: ' + r.status);
          return r.text();
        })
        .then(csv => {
          const data = parseCSV(csv);
          const todayRows = data; // Show all rows for testing
          document.getElementById('today').innerHTML = makeTable(todayRows, `All Active Reservations â€“ Updated ${new Date().toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric' })}`);
          document.getElementById('tomorrow').innerHTML = '';
          document.getElementById('time').textContent = new Date().toLocaleString();
        })
        .catch(err => {
          document.getElementById('today').innerHTML = `<div class="error">Error loading data: ${err.message}. Check CSV publish or CORS.</div>`;
        });
    }

    // Load now + every 60s
    render();
    setInterval(render, 60000);
  </script>
</body>
</html>
